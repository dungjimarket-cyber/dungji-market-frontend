# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview
Dungji Market (둥지마켓) is a Next.js-based group purchasing platform for telecommunications and internet services in Korea. Users can create and participate in group purchases to get better deals on mobile plans, internet services, and electronics.

**PWA Ready**: The application is now configured as a Progressive Web App (PWA) and ready for deployment to iOS App Store and Google Play Store.

## ⚠️ CRITICAL: 코드 분리 규칙

### 🚫 절대 수정 금지 규칙
**중고거래 기능 작업 시 공구(Group Purchase) 관련 코드는 절대 수정하지 마세요!**

1. **공구 전용 파일들 (수정 금지)**:
   - `src/app/mypage/MyPageClient.tsx` - 공구 마이페이지
   - `src/components/group-purchase/*` - 공구 관련 컴포넌트
   - `src/app/group-purchases/*` - 공구 페이지들
   - `src/app/seller-dashboard/*` - 판매자 대시보드
   - 기타 공구 관련 모든 파일

2. **중고거래 전용 파일들**:
   - `src/components/used/*` - 중고거래 컴포넌트
   - `src/app/used/*` - 중고거래 페이지들
   - `src/components/mypage/profile/ProfileSection.tsx` - 중고거래 프로필
   - `src/components/mypage/sales/*` - 판매 내역
   - `src/components/mypage/purchases/*` - 구매 내역
   - `src/components/mypage/favorites/*` - 찜 목록

3. **작업 원칙**:
   - ❌ 공구 코드 수정 시도 시 → **즉시 중단하고 사용자에게 확인 요청**
   - ✅ 중고거래 코드만 수정
   - ⚠️ 공통 파일 수정 필요 시 → **반드시 사용자에게 먼저 확인**

4. **공통 파일 수정 시 주의**:
   - `src/contexts/AuthContext.tsx` - 양쪽에서 사용, 수정 시 영향 확인 필수
   - `src/lib/api/*` - API 서비스 파일들
   - 타입 정의 파일들

**위반 시**: 공구 기능이 깨져서 큰 문제가 발생할 수 있습니다!

## Development Commands

### Core Commands
```bash
npm run dev           # Start development server (http://localhost:3000)
npm run build         # Build for production
npm run start         # Start production server
npm run lint          # Run ESLint
npm run test          # Run Jest tests
npm run test:watch    # Run tests in watch mode
npm run test:coverage # Run tests with coverage report
```

### Testing Commands
```bash
npm test -- src/__tests__/issue-verification.test.tsx  # Run specific test file
npm test -- --updateSnapshot                           # Update test snapshots
npm test -- --watchAll                                 # Run all tests in watch mode
npm test -- --coverage                                 # Generate coverage report
npm test -- src/components/                            # Test all files in directory
```

## Architecture Overview

### Tech Stack
- **Framework**: Next.js 15.1.6 with App Router
- **UI**: React 19, Tailwind CSS, Radix UI components
- **State Management**: Zustand for global state, React Hook Form for forms
- **Authentication**: NextAuth.js with JWT tokens, supports Kakao/Google OAuth
- **Backend Integration**: Axios for API calls, WebSocket for real-time features
- **API Base URL**: `${process.env.NEXT_PUBLIC_API_URL}` = `https://api.dungjimarket.com/api`
- **Testing**: Jest with React Testing Library
- **Deployment**: Vercel with serverless functions
- **PWA**: next-pwa with Service Worker and offline caching

### Key Directories
- `src/app/` - Next.js App Router pages and API routes
  - `src/app/api/` - Backend API routes (auth, groupbuys, payment, etc.)
  - `src/app/(partner)/` - Partner-specific routes with shared layout
- `src/components/` - Reusable React components organized by feature
  - `src/components/ui/` - Base UI components (shadcn/ui components)
  - `src/components/auth/` - Authentication-related components
  - `src/components/groupbuy/` - Group buying functionality components
- `src/contexts/` - React Context providers (AuthContext, PartnerContext)
- `src/lib/` - Utility functions and service layers
  - `src/lib/api/` - API service functions organized by feature
- `src/stores/` - Zustand stores for state management
- `src/types/` - TypeScript type definitions
- `src/hooks/` - Custom React hooks
- `src/middleware/` - Next.js middleware for authentication
- `public/` - Static assets including PWA icons and manifest

### PWA Configuration
- **Manifest**: `/public/manifest.json` - App metadata and icons
- **Service Worker**: Auto-generated by next-pwa
- **Icons**: Multiple sizes (72x72 to 512x512) in `/public/icons/`
- **Caching Strategy**: Network-first with 30-day expiration
- **Install Prompt**: Available on supported devices

### Authentication Flow
The app uses a dual authentication system:
1. **NextAuth.js** for OAuth providers (Kakao, Google)
2. **Custom JWT** implementation for email/password authentication
3. Auth tokens are stored in localStorage and managed via AuthContext
4. Role-based access control for buyers (일반회원) and sellers (판매자)

### API Integration Pattern
- **Base API URL**: `${process.env.NEXT_PUBLIC_API_URL}` = `https://api.dungjimarket.com/api`
- **API URL Pattern**: `${NEXT_PUBLIC_API_URL}/auth/endpoint` → `https://api.dungjimarket.com/api/auth/endpoint`
- **❗️ CRITICAL**: NEXT_PUBLIC_API_URL already includes `/api`, so NEVER add `/api` again!
- Auth headers automatically attached via axios interceptors
- Token refresh handled automatically on 401 responses
- API services organized in `src/lib/api/` by feature

#### ✅ Correct API URL Examples
- Profile: `${NEXT_PUBLIC_API_URL}/auth/profile/`
- Nickname Check: `${NEXT_PUBLIC_API_URL}/auth/check-nickname/`
- Nickname Change Status: `${NEXT_PUBLIC_API_URL}/auth/nickname-change-status/`
- Regions: `${NEXT_PUBLIC_API_URL}/regions/`

#### ❌ WRONG Examples (Never Use These!)
- `${NEXT_PUBLIC_API_URL}/api/auth/endpoint` ← WRONG! Duplicate `/api`
- `https://api.dungjimarket.com/auth/endpoint` ← WRONG! Hardcoded URL

#### 📋 Before Adding New API Calls:
1. Check existing API calls in the same file for pattern
2. Use `${NEXT_PUBLIC_API_URL}/path` format
3. Never add `/api` prefix to the path

### Key Features & Routes

#### User Types
- **일반회원 (Buyers)**: Can create/join group purchases
- **판매자 (Sellers)**: Can bid on group purchases, requires business verification

#### Main Pages
- `/` - Homepage with active group purchases
- `/group-purchases/create` - Create new group purchase
- `/groupbuys/[id]` - Group purchase detail page
- `/mypage` - User dashboard (different views for buyers/sellers)
- `/seller-dashboard` - Seller management interface
- `/bid-tickets` - Bid token purchase page

### Component Patterns
- Use existing UI components from `src/components/ui/`
- Follow shadcn/ui patterns for new components
- Client components marked with `'use client'` directive
- Server components by default in App Router

### Form Handling
- Use React Hook Form with Zod validation
- Form schemas defined alongside components
- Validation errors displayed via form.formState.errors

### Real-time Features
- Bid updates via WebSocket connections
- Timer synchronization for auction deadlines
- Notification system for bid status changes

## Environment Variables Required
```
NEXT_PUBLIC_API_URL              # Backend API URL
NEXT_PUBLIC_APP_URL              # Frontend URL
NEXTAUTH_URL                     # NextAuth base URL
NEXTAUTH_SECRET                  # NextAuth encryption secret
JWT_SECRET                       # JWT signing secret
KAKAO_CLIENT_ID                  # Kakao OAuth credentials
KAKAO_CLIENT_SECRET
GOOGLE_CLIENT_ID                 # Google OAuth credentials
GOOGLE_CLIENT_SECRET
```

## Common Development Tasks

### Adding a New Page
1. Create route in `src/app/[route]/page.tsx`
2. Add navigation link in DesktopNavbar/MobileNavbar if needed
3. Implement authentication check if required

### Creating API Routes
1. Add route handler in `src/app/api/[route]/route.ts`
2. Use NextResponse for responses
3. Handle auth verification via JWT tokens

### Working with Group Purchases
- Main types defined in `src/types/groupbuy.ts`
- State management via `src/stores/useGroupPurchase.ts`
- API services in `src/lib/api/`

### Styling Guidelines
- Use Tailwind CSS utility classes
- Follow existing component patterns
- Responsive design with mobile-first approach
- Dark mode not currently implemented

### PWA Development
- PWA disabled in development mode (next-pwa config)
- Test PWA features in production build: `npm run build && npm run start`
- Service worker updates on app reload
- Offline functionality for cached resources

## Development Workflow

**IMPORTANT: After implementing any feature or fix, ALWAYS follow this workflow:**

1. **Build the project** to check for compilation errors:
   ```bash
   npm run build
   ```

2. **Test the changes** locally if applicable:
   ```bash
   npm run dev
   # Test the feature in the browser
   ```

3. **Commit and push** the changes:
   ```bash
   git add -A
   git commit -m "type: description of changes
   
   - Detail 1
   - Detail 2
   
   🤖 Generated with [Claude Code](https://claude.ai/code)
   
   Co-Authored-By: Claude <noreply@anthropic.com>"
   git push origin main
   ```

**This workflow ensures:**
- Code compiles without errors before deployment
- Changes are tested locally
- All changes are properly versioned and deployed
- Vercel automatically deploys on push to main

## Testing Approach
- **Test Framework**: Jest with React Testing Library
- **Test Location**: Test files in `src/__tests__/` or alongside components
- **Path Aliases**: `@/` maps to `src/` directory
- **Coverage**: Excludes `*.d.ts`, `layout.tsx`, and `globals.css`
- **Transforms**: Configured to handle `lucide-react` imports
- Unit tests for utilities and hooks
- Integration tests for critical user flows
- Mock API responses for testing

## Deployment Notes
- Deployed on Vercel with automatic deployments on push to main branch
- Serverless functions for API routes with 60s timeout
- Cron jobs configured for status updates (`/api/cron/`)
- Image optimization disabled due to Vercel free tier limits
- Node.js version: >=18.0.0 (check `.nvmrc` for specific version)
- PWA files (service worker, manifest) auto-generated during build

## PWA Deployment
- **Ready for App Stores**: See `PWA_DEPLOYMENT_GUIDE.md` for complete deployment instructions
- **Recommended Tools**: PWABuilder.com for packaging iOS/Android apps
- **App Store Requirements**: All assets and metadata configured
- **Testing**: Use Chrome DevTools > Application > Manifest to test PWA features

## Linting and Code Quality
- **ESLint**: Uses flat config format with TypeScript parser
- **Unused Imports**: Plugin configured but disabled for flexibility
- **Next.js Rules**: Enforced for proper HTML link usage
- Lint command: `npm run lint`

## 중고폰 직거래 기능 (Used Phone Trading)

### 개발 문서
- **PRD**: `PRD_중고폰직거래.md` - 제품 요구사항 및 비즈니스 목표
- **기능 명세서**: `기능개발명세서_중고폰직거래.md` - 상세 기술 구현 사양
- **작업 관리**: `작업관리문서_중고폰직거래.md` - 진행 상황 및 이슈 트래킹

### 주요 기능
- **상품 관리**: 최대 5개 동시 등록, 다중 이미지 업로드
- **거래 시스템**: 가격 제안, 즉시구매, 거래 상태 관리
- **프로필 체크**: 중고폰 거래용 필수 정보 확인 (연락처, 활동지역)
- **검색/필터**: 브랜드, 가격, 용량, 상태별 필터링

### 핵심 컴포넌트
```
src/components/used/
├── UsedPhoneCard.tsx         # 상품 카드
├── UsedPhoneFilter.tsx        # 필터 UI  
├── UsedPhoneGallery.tsx       # 이미지 갤러리
├── PriceOfferModal.tsx        # 가격 제안 모달
├── RegistrationLimitModal.tsx # 등록 제한 안내
└── UsedPhoneForm.tsx          # 등록/수정 폼
```

### API 엔드포인트
- `GET/POST /api/used/phones/` - 상품 목록/등록
- `GET/PUT/DELETE /api/used/phones/{id}/` - 상품 상세/수정/삭제
- `POST /api/used/phones/{id}/offer/` - 가격 제안
- `GET /api/used/phones/{id}/my-offer/` - 내 제안 조회
- `POST /api/used/phones/{id}/favorite/` - 찜하기
- `GET /api/used/phones/check-limit/` - 등록 제한 체크

### Custom Hooks
- `useUsedPhoneProfileCheck()` - 중고폰 거래 프로필 체크
- `useImageUpload()` - 다중 이미지 업로드 처리
- `usePriceOffer()` - 가격 제안 관리

### 개발 현황
- **진행률**: 75% (Phase 1 완료, Phase 2 진행중)
- **완료**: 기본 CRUD, 이미지 업로드, 가격 제안, 찜하기
- **진행중**: 메시지 시스템, 거래 완료 프로세스
- **예정**: 평가 시스템, 검색 고도화, 알림 기능

## 💳 결제 시스템 (이니시스)

### 결제 방식별 처리 현황

#### ✅ 자동 처리 (완전 자동화)
- **카드 결제**: 즉시 완료 → 견적이용권 자동 지급
- **실시간 계좌이체**: 즉시 완료 → 견적이용권 자동 지급

#### ⚠️ 수동 처리 필요 (무통장입금)
**현재 상황:**
1. 고객이 무통장입금 선택 → 가상계좌 발급 (`waiting_deposit` 상태)
2. 고객이 은행에 입금
3. **관리자가 수동으로 처리해야 함:**
   - Django Admin → 결제 목록 → 입금 대기 필터
   - 해당 결제 선택 → "선택된 결제를 완료 처리" 액션 실행
   - ⚠️ **문제: 현재 견적이용권이 자동 지급되지 않음**

**필요한 개선사항:**
1. **단기 해결**: Django Admin의 `mark_as_completed` 액션에 견적이용권 지급 로직 추가
2. **장기 해결**: 웹훅 URL 연결 (`/api/payments/inicis/webhook/`)하여 완전 자동화
   - `api/urls.py`에 웹훅 라우팅 추가 필요
   - 이니시스 관리자 페이지에서 웹훅 URL 설정 필요

### 결제 오류 처리
- 결제 실패 시 상세 오류 메시지 표시 (카드 한도, 잔액 부족 등)
- `INICIS_ERROR_MESSAGES`에 한국어 오류 메시지 매핑 완료

## Git 커밋/푸시 방법

### Frontend 변경사항 커밋/푸시
```bash
# 1. frontend 디렉토리로 이동
cd dungji-market-frontend

# 2. 변경사항 스테이징 및 커밋
git add -A
git commit -m "커밋 메시지"

# 3. main 브랜치로 푸시
git push origin main

# 4. 상위 디렉토리로 돌아가서 submodule 업데이트
cd ..
git add dungji-market-frontend
git commit -m "update: sync frontend submodule for [변경내용]"
```

**주의**: 메인 저장소는 현재 remote 설정 문제로 푸시가 안되므로, frontend 서브모듈만 푸시하면 됨.

# important-instruction-reminders
Do what has been asked; nothing more, nothing less.
NEVER create files unless they're absolutely necessary for achieving your goal.
ALWAYS prefer editing an existing file to creating a new one.
NEVER proactively create documentation files (*.md) or README files. Only create documentation files if explicitly requested by the User.

## 🎨 UI/UX 디자인 원칙

### 텍스트 및 레이아웃
- **줄바꿈 방지**: Badge, Button 등의 컴포넌트에서 `whitespace-nowrap` 사용으로 텍스트 줄바꿈 방지
- **컴팩트한 디자인**:
  - 작은 버튼: `size="sm"` + `text-xs` + `px-3 py-1.5`
  - 작은 아이콘: `w-3 h-3` 사용
  - 텍스트 최소화: "노쇼신고하기" → "신고하기"

### 색상 구성
- **과하지 않은 색상 사용**:
  - 경고/위험: `text-red-600 border-red-300 hover:bg-red-50` (빨간색 테두리 + 연한 호버)
  - 대기/검토중: `bg-gray-100 text-gray-700` (연한 회색 배경)
  - 성공/승인: 기본 Badge variant 사용
  - 실패/반려: destructive variant 사용

### 버튼 스타일 가이드
```tsx
// 작은 아웃라인 버튼 (권장)
<Button
  variant="outline"
  size="sm"
  className="flex items-center gap-1 text-red-600 border-red-300 hover:bg-red-50 text-xs px-3 py-1.5"
>
  <Icon className="w-3 h-3" />
  텍스트
</Button>

// Badge 줄바꿈 방지
<Badge className="bg-gray-100 text-gray-700 inline-flex whitespace-nowrap">
  <Icon className="w-3 h-3 mr-1 flex-shrink-0" />
  <span>텍스트</span>
</Badge>
```

## 🚨 필드 접근 오류 방지 원칙
**문제**: 백엔드에서 존재하지 않는 필드 접근 시 AttributeError로 500 오류 발생 (5시간 디버깅)

**해결 방법**:
1. **필드 추가 전 DB 모델 확인 필수**
   - `api/models.py`에서 User, GroupBuy 등 모델의 실제 필드 확인
   - 프론트엔드에 있는 필드가 백엔드에도 있다고 가정하지 말 것

2. **프론트엔드와 백엔드 필드명 차이 주의**
   - 프론트: `user?.user_type` (optional chaining으로 안전)
   - 백엔드: `user.user_type` (직접 접근 시 필드 없으면 에러)

3. **디버깅 시 즉시 확인**
   - 500 오류 발생 시 상세 오류 메시지 반환하도록 수정
   - `AttributeError: 'Model' object has no attribute 'field'` 형태 오류는 DB 모델 확인

**예시 - User 모델 필드**:
- ✅ 존재: `role` (buyer/seller)
- ❌ 없음: `user_type`

**교훈**: "혹시 모르니까" 방어 코드가 오히려 문제 일으킬 수 있음. 실제 DB 스키마 확인이 최우선!

## 핵심 작업 원칙 (시간이 돈이다)
1. **임시방편 금지** - 근본적인 해결책만 제시
2. **반복 실수 방지**:
   - API URL에 /api 중복 추가 ❌ (NEXT_PUBLIC_API_URL에 이미 포함)
   - DB 문제를 수동 명령어로 해결 ❌ → 코드로 자동 해결 ✅
   - 문제 원인 파악 전 해결책 제시 ❌ → 원인 분석 후 한 번에 해결 ✅
3. **패턴 인식**:
   - 404 오류 → URL 경로 또는 ViewSet 위치 문제
   - 상태 불일치 → 모델 로직 또는 상태 전환 문제
   - 카운트 오류 → Serializer에서 실시간 계산으로 해결
4. **첫 번째 해결책 = 최종 해결책** (여러 번 수정 금지)
5. **기존 코드 수정 원칙**:
   - 새 기능 추가 시 기존 작동 코드는 절대 수정 금지
   - 특히 Serializer 필드명은 모델과 정확히 일치해야 함
   - 필드 추가만 하고, 기존 필드는 건드리지 않기
   - 수정 전 항상 원본 상태 확인 필수
   - ListSerializer와 DetailSerializer 필드명 일관성 유지

## 🏗️ 통합 모델 마이그레이션 (2025.09)

### 통합 찜/후기 시스템
**목적**: 휴대폰과 전자제품의 찜/후기를 하나의 테이블로 통합 관리

#### UnifiedFavorite (통합 찜)
```python
# api/models_unified_simple.py
class UnifiedFavorite:
    user = ForeignKey(User)
    item_type = CharField(choices=['phone', 'electronics'])
    item_id = PositiveIntegerField()
    created_at = DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ('user', 'item_type', 'item_id')
```

#### UnifiedReview (통합 후기)
```python
class UnifiedReview:
    item_type = CharField(choices=['phone', 'electronics'])
    transaction_id = PositiveIntegerField()  # 거래 ID
    reviewer = ForeignKey(User, related_name='written_reviews')
    reviewee = ForeignKey(User, related_name='received_reviews')
    rating = IntegerField(1-5)
    comment = TextField()
    is_from_buyer = BooleanField()  # 구매자/판매자 구분
    # 추가 평가 항목
    is_punctual = BooleanField()
    is_friendly = BooleanField()
    is_honest = BooleanField()
    is_fast_response = BooleanField()
```

#### Migration 주의사항
1. **unique_together 변경 시**: 먼저 기존 제약조건 제거 → 필드 수정 → 새 제약조건 설정
2. **필드명 변경**: RenameField 사용 (예: reviewed_user → reviewee)
3. **필드 타입 변경**: RemoveField → AddField 순서로 진행
4. **AlterUniqueTogether 파라미터**: `name=` 사용 (`model_name=` 아님)

#### 제거된 모델들
- ❌ `UsedPhoneFavorite` → ✅ `UnifiedFavorite`
- ❌ `ElectronicsFavorite` → ✅ `UnifiedFavorite`
- ❌ `UsedPhoneReview` → ✅ `UnifiedReview`

#### API 엔드포인트 변경
**찜하기**:
- 이전: POST만으로 토글
- 현재: POST (추가) / DELETE (제거) 명확히 구분
```javascript
// Frontend
const method = isFavorited ? 'delete' : 'post';
await api[method](`/${id}/favorite/`);
```

**후기**:
- Backend는 UnifiedReview 사용하지만 기존 API 엔드포인트 유지
- Serializer에서 backward compatibility 제공 (transaction → transaction_id 매핑)

### 전자제품 상태 등급 개선
```javascript
// 기존: S급/A급/B급/C급
// 개선안 (타 플랫폼 참조):
CONDITION_CHOICES = [
    ('new_unopened', '미개봉'),
    ('like_new', '거의 새 것'),
    ('minor_signs', '사용감 적음'),
    ('visible_signs', '사용감 있음'),
    ('heavy_signs', '사용감 많음')
]
```

### prefetch_related 정리
```python
# 삭제된 관계는 prefetch에서 제거 필수
queryset = UsedPhone.objects.prefetch_related(
    'regions__region',
    'images',
    # 'favorites',  # ❌ 제거됨
    'transactions'
)

      
      IMPORTANT: this context may or may not be relevant to your tasks. You should not respond to this context unless it is highly relevant to your task.