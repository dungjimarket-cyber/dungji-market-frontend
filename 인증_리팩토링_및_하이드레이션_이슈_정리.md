# Dungji Market 프론트엔드 인증 리팩토링 및 Hydration 이슈 정리

## 1. 리팩토링/수정 배경

- JWT 기반 인증을 프론트 전체에서 일관되게 사용하기 위함
- SSR/CSR 불일치(hydration error)로 인한 React 경고 및 예기치 않은 UI 동작 방지
- 타입 불일치, undefined 오류 등 실사용 중 발생하는 문제 예방

---

## 2. 주요 수정 내역

### 1) 인증(JWT) 구조 일원화
- 모든 API 인증 요청에서 JWT 토큰만 사용하도록 통일
- `useSession()`에서 토큰 접근 시 `session.jwt?.access` 또는 `session.user?.jwt?.access`로 일관
- NextAuth 타입 정의(`src/types/next-auth.d.ts`)에 `jwt` 구조 명확히 추가

### 2) SSR/CSR 불일치(hydration) 이슈 예방
- `useSession()` 사용 시 `status === "loading"`이면 렌더링을 보류하여 hydration mismatch 방지
- 날짜, 랜덤값, 브라우저 전용 객체(window 등)는 SSR에서 사용 금지
- 조건부 렌더링 및 클라이언트 전용 로직은 `useEffect` 활용

### 3) 타입 안전성 및 기타 개선
- `GroupBuy` 등 주요 타입에 서버 응답 필드(`calculated_status`, `remaining_seconds`) 명확히 추가
- undefined 체크 및 타입 오류 제거

---

## 3. 적용 예시

### [A] 인증 토큰 접근 방식 통일
```tsx
const { data: session, status } = useSession();
if (status === "loading") return null; // hydration mismatch 방지
const accessToken = session?.jwt?.access || session?.user?.jwt?.access;
```

### [B] 타입 정의 확장
```ts
// src/types/next-auth.d.ts
interface User {
  ...
  jwt?: {
    access: string;
    refresh: string;
  }
}
interface Session {
  ...
  jwt?: {
    access: string;
    refresh: string;
  }
}
```

### [C] GroupBuy 타입 확장
```ts
interface GroupBuy {
  ...
  calculated_status?: string;
  remaining_seconds?: number;
}
```

### [D] undefined 체크 예시
```tsx
{((groupBuy.remaining_seconds !== undefined && groupBuy.remaining_seconds > 0) || new Date(groupBuy.end_time) > new Date()) && (
  <div>...</div>
)}
```

---

## 4. 추가 가이드 및 주의사항

- SSR/CSR 불일치(hydration error)는 대부분 `useSession`의 로딩 상태 미처리, 브라우저 전용 객체 사용, 랜덤/날짜 값 SSR 사용 등에서 발생함
- 인증 흐름은 반드시 JWT 기반으로 통일, accessToken/refreshToken 혼용 금지
- 타입스크립트 인터페이스에 서버 응답 필드는 명확히 정의
- NextAuth 콜백에서 JWT 토큰을 세션에 올바르게 할당하는지 확인
- 환경변수(process.env.*) 사용 시 빌드/런타임 차이 주의

---

## 5. 결론

이 리팩토링을 통해 인증 및 렌더링 일관성이 크게 개선되었으며, 실사용 중 발생하는 인증 오류와 hydration error를 예방할 수 있습니다.

궁금한 점이나 추가 개선 요청이 있으면 언제든 말씀해주세요!
